<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分數管理工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        #loadingOverlay { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(4px); transition: opacity 0.3s ease; }
        
        .admin-only, .admin-only-inline { display: none; }
        body.is-admin .admin-only { display: flex; }
        body.is-admin .admin-only-inline { display: inline-flex; }
        
        #loginOverlay { display: flex; }
        body.is-logged-in #loginOverlay { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen">

    <div id="loginOverlay" class="fixed inset-0 z-[110] bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-sm:max-w-xs max-w-sm overflow-hidden fade-in">
            <div class="p-6 bg-blue-600 text-white text-center">
                <h2 class="text-2xl font-bold">分數管理工具</h2>
                <p class="text-blue-100 text-sm mt-1">請登入帳號以開始使用</p>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">帳號</label>
                    <input type="text" id="auth_user" class="w-full border p-2.5 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Username">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">密碼</label>
                    <input type="password" id="auth_pass" class="w-full border p-2.5 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Password">
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="handleAuth('login')" class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-lg">登入</button>
                    <button onclick="handleAuth('register')" class="flex-1 bg-slate-100 text-slate-600 py-2.5 rounded-lg font-bold hover:bg-slate-200 transition-colors">註冊</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="fixed inset-0 z-[120] flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p id="loadingText" class="text-slate-600 font-medium text-lg text-center px-4">正在連線資料庫...</p>
        </div>
    </div>

    <div class="flex flex-col md:flex-row flex-1 overflow-hidden">
        <div class="flex-1 p-4 md:p-8 overflow-y-auto h-screen pb-32 custom-scrollbar">
            <header class="mb-8 flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4">
                <div>
                    <div class="flex flex-wrap gap-2 mb-4" id="groupTabs"></div>
                    <div class="flex items-center gap-3">
                        <h1 id="mainTitle" class="text-3xl font-bold text-slate-900 flex items-center gap-2">
                            <i data-lucide="trophy" class="text-yellow-500 w-8 h-8"></i>
                            <span id="currentGroupNameDisplay">讀取中...</span>
                        </h1>
                        <span id="cloudStatus" class="inline-block w-3 h-3 rounded-full bg-slate-300"></span>
                    </div>
                    <div id="userInfo" class="mt-2 text-xs text-slate-500 flex items-center gap-2">
                        <i data-lucide="user" class="w-3 h-3"></i>
                        <span id="displayUsername">未登入</span>
                        <span id="adminBadge" class="hidden px-1.5 py-0.5 bg-blue-100 text-blue-600 rounded-full font-bold">管理者</span>
                        <span id="viewerBadge" class="hidden px-1.5 py-0.5 bg-slate-100 text-slate-600 rounded-full font-bold border border-slate-200">唯讀</span>
                        <button onclick="logout()" class="ml-2 text-blue-600 hover:underline font-bold">登出系統</button>
                    </div>
                </div>
                <div class="flex gap-2 flex-wrap items-center">
                    <button onclick="openAddMemberModal()" class="admin-only px-4 py-2 text-sm text-green-600 bg-white border border-green-200 rounded-lg hover:bg-green-50 flex items-center gap-2 shadow-sm font-bold transition-all">
                        <i data-lucide="user-plus" class="w-4 h-4"></i> 新增成員
                    </button>
                    <button onclick="openCreateGroupModal()" class="px-4 py-2 text-sm text-blue-600 bg-white border border-blue-200 rounded-lg hover:bg-blue-50 flex items-center gap-2 shadow-sm font-bold transition-all">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i> 建立新群組
                    </button>
                </div>
            </header>
            <div id="studentList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </div>
        <div class="w-full md:w-80 bg-white border-l border-slate-200 flex flex-col h-96 md:h-screen z-10">
            <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h2 class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="history" class="w-5 h-5"></i> 近期紀錄</h2>
            </div>
            <div id="logList" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar"></div>
        </div>
    </div>

    <footer class="bg-slate-50 border-t border-slate-200 py-4 text-center text-sm text-slate-500 w-full">
        版權所有 © 2026 <a href="https://pandapanda6666.github.io" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium transition-colors">PandaPanda的AI日常</a> All Rights Reserved.
    </footer>

    <div id="createGroupModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[100] fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="p-4 bg-blue-600 text-white flex justify-between items-center">
                <h3 class="text-lg font-bold">建立新群組</h3>
                <button onclick="closeModal('createGroupModal')" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-bold text-slate-700 mb-2">名稱</label><input type="text" id="cg_name" class="w-full border p-2 rounded-lg"></div>
                    <div><label class="block text-sm font-bold text-slate-700 mb-2">模式</label><select id="cg_type" onchange="resetCGMembers()" class="w-full border p-2 rounded-lg bg-slate-50"><option value="Family">家庭模式</option><option value="Class">教室模式</option></select></div>
                </div>
                <div id="cg_memberList" class="space-y-3"></div>
                <button onclick="addCGMemberRow()" class="text-xs text-blue-600 flex items-center gap-1 font-bold"><i data-lucide="plus" class="w-3 h-3"></i> 增加成員欄位</button>
            </div>
            <div class="p-4 border-t bg-slate-50 flex gap-3">
                <button onclick="closeModal('createGroupModal')" class="flex-1 py-2 bg-white border rounded-lg">取消</button>
                <button onclick="doCreateGroup()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">確認建立</button>
            </div>
        </div>
    </div>

    <div id="addMemberModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[100] fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="p-4 bg-green-600 text-white flex justify-between items-center">
                <h3 class="text-lg font-bold">新增群組成員</h3>
                <button onclick="closeModal('addMemberModal')" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4" id="am_body"></div>
            <div class="p-4 border-t bg-slate-50 flex gap-3">
                <button onclick="closeModal('addMemberModal')" class="flex-1 py-2 bg-white border rounded-lg">取消</button>
                <button onclick="doAddMember()" class="flex-1 py-2 bg-green-600 text-white rounded-lg font-bold">確認新增</button>
            </div>
        </div>
    </div>

    <div id="actionModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[100] fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
            <div id="modalHeader" class="p-4 text-white flex justify-between items-center">
                <h3 id="modalTitle" class="text-lg font-bold">標題</h3>
                <button onclick="closeModal('actionModal')" class="hover:bg-white/20 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="modalBody" class="p-6"></div>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[100] fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden p-6 text-center">
            <h3 id="confirmTitle" class="text-lg font-bold text-red-600 mb-2">確認</h3>
            <div id="confirmMessage" class="text-slate-600 mb-6 text-sm"></div>
            <div id="confirmActions" class="flex gap-3"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, updateDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB" + "fcEn8qTpb0hU3lw1TY2JGp9sdRAIrIpw",
            authDomain: "project-1653617986338237438.firebaseapp.com",
            projectId: "project-1653617986338237438",
            storageBucket: "project-1653617986338237438.firebasestorage.app",
            messagingSenderId: "166823670261",
            appId: "1:166823670261:web:6e253ca6be9ac57ad870bc"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "honor-roll-v2-production";

        let currentUser = localStorage.getItem('award_username') || null;
        let groups = [];
        let currentGroupData = null;
        let currentStudentId = null, currentModalType = 'reward', currentScoreValue = 1;

        const DEFAULT_REASONS = {
            Family: { reward: ['幫忙家事', '乖乖吃飯', '準時睡覺', '禮貌待人', '自理能力佳'], punish: ['吵鬧不休', '不收玩具', '挑食偏食', '態度不佳', '沒寫功課'] },
            Class: { reward: ['表現優異', '作業準時', '熱心助人', '進步顯著', '打掃認真'], punish: ['遲到早退', '未交作業', '秩序不佳', '忘記帶東西', '態度不佳'] }
        };

        window.addEventListener('DOMContentLoaded', async () => {
            showLoading('正在連線資料庫...');
            await signInAnonymously(auth);
            if (currentUser) { document.body.classList.add('is-logged-in'); initApp(); }
            else hideLoading();
            lucide.createIcons();
        });

        window.handleAuth = async (type) => {
            const u = document.getElementById('auth_user').value.trim();
            const p = document.getElementById('auth_pass').value.trim();
            if (!u || !p) return;
            showLoading('驗證中...');
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'users', u);
            const snap = await getDoc(ref);
            if (type === 'register') {
                if (snap.exists()) { hideLoading(); return alert('帳號已存在'); }
                await setDoc(ref, { username: u, password: p, role: 'User' });
                alert('註冊成功！'); hideLoading();
            } else {
                if (snap.exists() && snap.data().password === p) {
                    currentUser = u; localStorage.setItem('award_username', u);
                    document.body.classList.add('is-logged-in'); initApp();
                } else { hideLoading(); alert('帳密錯誤'); }
            }
        };

        window.logout = () => { localStorage.removeItem('award_username'); location.reload(); };

        async function initApp() {
            if (!auth.currentUser) return;
            showLoading('讀取群組...');
            document.getElementById('displayUsername').innerText = currentUser;
            const groupsRef = collection(db, 'artifacts', appId, 'public', 'data', 'groups');
            onSnapshot(groupsRef, (snapshot) => {
                groups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(g => 
                    (g.admins && g.admins.includes(currentUser)) || 
                    (g.viewers && g.viewers.includes(currentUser)) || 
                    (g.members && g.members.some(m => m.username === currentUser))
                );
                renderTabs();
                if (groups.length > 0) loadGroupData(currentGroupData?.id || groups[0].id);
                else hideLoading();
            });
        }

        async function loadGroupData(groupId) {
            const groupRef = doc(db, 'artifacts', appId, 'public', 'data', 'groups', groupId);
            const snap = await getDoc(groupRef);
            if (!snap.exists()) return;
            currentGroupData = { id: snap.id, ...snap.data() };
            document.getElementById('currentGroupNameDisplay').innerText = currentGroupData.name;
            const isAdmin = currentGroupData.admins && currentGroupData.admins.includes(currentUser);
            document.body.classList.toggle('is-admin', isAdmin);
            renderTabs(); renderStudents(currentGroupData.members || []); loadLogs(groupId); hideLoading();
        }

        function loadLogs(groupId) {
            const logsRef = collection(db, 'artifacts', appId, 'public', 'data', 'logs');
            onSnapshot(logsRef, (snapshot) => {
                const filtered = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(l => l.groupId === groupId).sort((a, b) => b.timestamp - a.timestamp).slice(0, 30);
                document.getElementById('logList').innerHTML = filtered.length === 0 ? '<p class="text-center py-4 text-xs">無紀錄</p>' : filtered.map(log => `
                    <div class="group relative text-sm border-b border-slate-50 pb-2 mb-2 hover:bg-slate-50 p-1 rounded">
                        <div class="flex justify-between font-bold pr-6"><span>${log.studentName}</span><span class="text-[9px] text-slate-400">${new Date(log.timestamp).toLocaleTimeString()}</span></div>
                        <div class="text-slate-600 text-[11px]">${log.reason} <span class="${log.change >= 0 ? 'text-green-600' : 'text-red-600'} font-bold">(${log.change >= 0 ? '+' : ''}${log.change})</span></div>
                        <button onclick="window.deleteFirebaseLog('${log.id}')" class="admin-only-inline absolute right-0 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`).join('');
                lucide.createIcons();
            });
        }

        window.deleteFirebaseLog = async (logId) => {
            const logRef = doc(db, 'artifacts', appId, 'public', 'data', 'logs', logId);
            const logSnap = await getDoc(logRef);
            if (!logSnap.exists()) return;
            const log = logSnap.data();
            // 回溯分數
            const updatedMembers = currentGroupData.members.map(m => m.name === log.studentName ? { ...m, score: m.score - log.change } : m);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', currentGroupData.id), { members: updatedMembers });
            await deleteDoc(logRef);
            loadGroupData(currentGroupData.id);
        };

        function renderTabs() {
            document.getElementById('groupTabs').innerHTML = groups.map(g => `<button onclick="window.loadGroupData('${g.id}')" class="px-4 py-1.5 rounded-full text-sm font-bold transition-all ${currentGroupData?.id === g.id ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600'}">${g.name}</button>`).join('');
        }
        window.loadGroupData = loadGroupData;

        function renderStudents(memberList) {
            const container = document.getElementById('studentList');
            container.innerHTML = memberList.length === 0 ? '<div class="col-span-full py-12 text-center text-slate-400">目前群組無成員</div>' : '';
            [...memberList].sort((a, b) => b.score - a.score).forEach((p, i) => {
                const isMe = p.username === currentUser;
                const div = document.createElement('div');
                div.className = `relative rounded-xl border p-5 flex flex-col items-center fade-in shadow-sm ${isMe ? 'bg-blue-50 border-blue-200 ring-2 ring-blue-400' : 'bg-white border-slate-200'}`;
                let infoTag = p.info1 + (currentGroupData.type === 'Class' && p.info1 === '學生' && p.info2 ? ` (${p.info2})` : '');
                div.innerHTML = `<div class="w-full flex justify-between mb-2"><span class="text-[10px] text-slate-400 font-bold uppercase">#${i+1} ${infoTag}</span><button onclick="window.requestConfirm('delete', '${p.id}', '${p.name}')" class="admin-only-inline text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div><div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center font-bold mb-1 text-slate-600 text-xl">${p.name[0]}</div><h3 class="font-bold text-lg">${p.name}</h3><div class="text-[10px] text-slate-400 mb-2 truncate max-w-full">${p.username || '未綁定'} ${isMe ? '⭐' : ''}</div><div class="text-3xl font-black my-3 ${p.score >= 0 ? 'text-green-600' : 'text-red-600'}">${p.score > 0 ? '+'+p.score : p.score}</div><div class="admin-only gap-2 w-full mt-1"><button onclick="window.openActionModal('${p.id}', 'punish')" class="flex-1 py-1.5 px-2 bg-red-50 text-red-600 rounded border border-red-100 text-xs font-bold">扣分</button><button onclick="window.openActionModal('${p.id}', 'reward')" class="flex-1 py-1.5 px-2 bg-green-50 text-green-600 rounded border border-green-100 text-xs font-bold">加分</button></div>`;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        window.openActionModal = (id, type) => {
            currentStudentId = id; currentModalType = type;
            const p = currentGroupData.members.find(s => s.id == id);
            currentScoreValue = 1;
            renderActionModalBody(currentGroupData.type || 'Family', type, p.name);
            document.getElementById('actionModal').style.display = 'flex';
        };

        function renderActionModalBody(mode, type, name) {
            const custom = (currentGroupData.customReasons && currentGroupData.customReasons[mode] && currentGroupData.customReasons[mode][type]) || [];
            const excluded = (currentGroupData.excludedReasons && currentGroupData.excludedReasons[mode] && currentGroupData.excludedReasons[mode][type]) || [];
            const all = [...new Set([...DEFAULT_REASONS[mode][type], ...custom])].filter(r => !excluded.includes(r));

            document.getElementById('modalTitle').innerText = (type === 'reward' ? '加分：' : '扣分：') + name;
            document.getElementById('modalHeader').className = 'p-4 text-white flex justify-between items-center ' + (type === 'reward' ? 'bg-green-500' : 'bg-red-500');
            document.getElementById('modalBody').innerHTML = `<div class="mb-5">
                <div class="flex justify-between items-end mb-2"><p class="text-sm text-slate-500 font-bold">點數：</p><div class="font-black text-2xl ${type === 'reward' ? 'text-green-600' : 'text-red-600'}" id="scorePreview">${type === 'reward' ? '+' : '-'}${currentScoreValue}</div></div>
                <div id="scoreOptions" class="flex flex-wrap gap-2 mb-4">
                    ${[1,2,3,4,5].map(v => `<button onclick="window.setScorePreset(${v})" class="score-btn flex-1 min-w-[40px] py-2 rounded border ${currentScoreValue === v ? 'bg-slate-800 text-white' : 'bg-white'}">${v}</button>`).join('')}
                    <input type="number" id="customScoreInput" oninput="window.setCustomScore(this.value)" placeholder="自訂" class="flex-1 min-w-[60px] border rounded text-center text-sm outline-none">
                </div>
                <div class="grid grid-cols-2 gap-2 mb-6">${all.map(r => `
                    <div class="flex gap-1">
                        <button onclick="window.commitScore('${r}')" class="flex-1 py-2 border rounded text-[10px] font-bold truncate px-1">${r}</button>
                        <button onclick="window.removeReason('${mode}', '${type}', '${r}')" class="px-1 text-slate-300 hover:text-red-500 border rounded"><i data-lucide="x" class="w-3 h-3"></i></button>
                    </div>`).join('')}</div>
                <div class="flex gap-2 pt-4 border-t border-slate-100"><input type="text" id="customReason" placeholder="自訂理由並加入..." class="flex-1 border rounded px-3 py-2 text-sm outline-none"><button onclick="window.addAndCommitFirebase()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold">確認</button></div>
            </div>`;
            lucide.createIcons(); updateScoreUI();
        }

        window.setScorePreset = (v) => { currentScoreValue = v; document.getElementById('customScoreInput').value = ''; updateScoreUI(); };
        window.setCustomScore = (v) => { currentScoreValue = parseInt(v) || 0; updateScoreUI(); };
        function updateScoreUI() {
            document.getElementById('scorePreview').innerText = (currentModalType === 'reward' ? '+' : '-') + Math.abs(currentScoreValue);
            document.querySelectorAll('.score-btn').forEach((b, i) => b.className = (i+1 === currentScoreValue) ? "score-btn flex-1 min-w-[40px] py-2 rounded border bg-slate-800 text-white" : "score-btn flex-1 min-w-[40px] py-2 rounded border bg-white");
        }

        window.removeReason = async (mode, type, reason) => {
            let custom = currentGroupData.customReasons || {};
            let excluded = currentGroupData.excludedReasons || {};
            if (!custom[mode]) custom[mode] = { reward: [], punish: [] };
            if (!excluded[mode]) excluded[mode] = { reward: [], punish: [] };
            
            if (DEFAULT_REASONS[mode][type].includes(reason)) excluded[mode][type].push(reason);
            else custom[mode][type] = custom[mode][type].filter(r => r !== reason);
            
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', currentGroupData.id), { customReasons: custom, excludedReasons: excluded });
            const p = currentGroupData.members.find(s => s.id == currentStudentId);
            renderActionModalBody(mode, currentModalType, p.name);
        };

        window.addAndCommitFirebase = async () => {
            const r = document.getElementById('customReason').value.trim(); if (!r) return;
            const mode = currentGroupData.type || 'Family';
            let custom = currentGroupData.customReasons || {};
            if (!custom[mode]) custom[mode] = { reward: [], punish: [] };
            if (!DEFAULT_REASONS[mode][currentModalType].includes(r) && !custom[mode][currentModalType].includes(r)) custom[mode][currentModalType].push(r);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', currentGroupData.id), { customReasons: custom });
            window.commitScore(r);
        };

        window.commitScore = async (reason) => {
            const change = currentScoreValue * (currentModalType === 'reward' ? 1 : -1);
            const student = currentGroupData.members.find(m => m.id == currentStudentId);
            const updated = currentGroupData.members.map(m => m.id == currentStudentId ? { ...m, score: m.score + change } : m);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', currentGroupData.id), { members: updated });
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), { groupId: currentGroupData.id, studentName: student.name, change, reason, timestamp: Date.now() });
            closeModal('actionModal'); loadGroupData(currentGroupData.id);
        };

        function showLoading(t) { document.getElementById('loadingOverlay').classList.remove('hidden'); document.getElementById('loadingText').innerText = t; }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
    </script>
</body>
</html>
